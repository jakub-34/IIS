<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Reservations</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div class="header-container">
        <h2 id="header" style="float: left;">
            <a href="index.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home" style="margin-right: 5px;"></i>
            </a>
            <a id="conferenceDetailsLink" href="#" style="margin-left: 0.8vw; opacity: 0.5;">Conference Details</a>
            <a id="suggestionsLink" href="#" style="margin-left: 0.8vw; opacity: 0.5;">Suggestions</a>
            <a href="#" style="margin-left: 0.8vw; color: white;">Reservations</a>
        </h2>
        <div style="float: right;">
            <a href="login.html" id="loginLogoutButton" class="login-button">Login</a>
            <a href="user_schedule.html" id="myScheduleButton" class="login-button" style="margin-right: 10px; display: none;">My Schedule</a>
            <a href="user_reservations.html" id="myReservationButton" class="login-button" style="margin-right: 10px; display: none;">My Reservation</a>
            <a href="admin_page.html" id="adminPageButton" class="login-button" style="display: none; margin-right: 10px;">Admin Page</a>
        </div>
    </div>
    
    <div class="body">
        <div style="margin-bottom: 20px;">
            <input type="text" id="searchBar" placeholder="Search by last name..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
        </div>
        <ul id="reservationList" style="list-style: none; padding: 0;">
            <!-- Reservations will be dynamically populated here -->
        </ul>
    </div>

    <script>
        function checkLoginStatus() {
            fetch('check_session.php')
                .then(response => response.json())
                .then(data => {
                    const loginLogoutButton = document.getElementById('loginLogoutButton');
                    const adminPageButton = document.getElementById('adminPageButton');
                    const myScheduleButton = document.getElementById('myScheduleButton');
                    const conferenceButton = document.getElementById('create_presentation');
                    const myReservationButton = document.getElementById('myReservationButton');
                
                    if (data.isLoggedIn) {
                        isLoggedIn = true; // Nastavíme stav přihlášení
                        loginLogoutButton.textContent = 'Logout';
                        loginLogoutButton.href = 'logout.php';
                        myScheduleButton.style.display = 'inline-block';
                        myReservationButton.style.display = 'inline-block';
                        reserveTicketButton.href = `user_reservations.html?conference_id=${conferenceId}`;
                    
                        if (data.role === 'admin') {
                            adminPageButton.style.display = 'inline-block';
                        }
                    
                        conferenceButton.style.display = 'flex';
                    } else {
                        loginLogoutButton.textContent = 'Login';
                        loginLogoutButton.href = 'login.html';
                        reserveTicketButton.href = `reserve_tickets.html?conference_id=${conferenceId}`;
                    }
                })
            .catch(error => console.error('Chyba při kontrole přihlášení:', error));
        }
        // Extract the current `id` parameter from the URL
        function getConferenceId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // Get the `id` parameter
        }

        // Set the correct `id` for the links
        function updateLinks() {
            const id = getConferenceId();

            if (id) {
                document.getElementById('conferenceDetailsLink').href = `conference_details.html?id=${id}`;
                document.getElementById('suggestionsLink').href = `suggestions.html?id=${id}`;
            }
        }

        // Fetch reservations and populate the list
    function fetchReservations() {
        const conferenceId = getConferenceId();
        const status = "pending";

        fetch(`get_reservations.php?conference_id=${conferenceId}&status=${status}`)
            .then(response => response.json())
            .then(data => {
                const reservationList = document.getElementById('reservationList');
                reservationList.innerHTML = ''; // Clear the list

                data.forEach(reservation => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${reservation.name} ${reservation.lastname}`;
                    listItem.dataset.lastname = reservation.lastname.toLowerCase(); // Store lowercase last name for searching
                    listItem.dataset.reservationId = reservation.reservation_id;
                    listItem.style.display = 'flex';
                    listItem.style.alignItems = 'center';
                    listItem.style.justifyContent = 'space-between';
                    listItem.style.padding = '10px';
                    listItem.style.border = '1px solid #ccc';
                    listItem.style.borderRadius = '5px';
                    listItem.style.marginBottom = '10px';
                    listItem.style.backgroundColor = '#f9f9f9';

                    // Confirm Payment Button
                    const confirmButton = document.createElement('button');
                    confirmButton.textContent = 'Confirm Payment';
                    confirmButton.style.padding = '5px 10px';
                    confirmButton.style.backgroundColor = '#4CAF50';
                    confirmButton.style.color = 'white';
                    confirmButton.style.border = 'none';
                    confirmButton.style.borderRadius = '3px';
                    confirmButton.style.cursor = 'pointer';
                    confirmButton.style.fontSize = '14px';

                    confirmButton.addEventListener('click', () => {
                        const reservationId = reservation.reservation_id;
                        confirmPayment(reservationId, listItem);
                    });

                    listItem.appendChild(confirmButton);
                    reservationList.appendChild(listItem);
                });
            })
        .catch(error => console.error('Error fetching reservations:', error));
    }


        // Filter reservations based on the search bar
        function filterReservations() {
            const searchQuery = document.getElementById('searchBar').value.toLowerCase();
            const reservations = document.querySelectorAll('#reservationList li');

            reservations.forEach(item => {
                const lastname = item.dataset.lastname;
                if (lastname.includes(searchQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Confirm payment and update the status in the database
        function confirmPayment(reservationId, listItem) {
            fetch('confirm_payment.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reservation_id: reservationId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        listItem.remove(); // Remove the item from the list after confirmation
                        console.log('Payment confirmed for reservation ID:', reservationId);

                        // Check if the list is now empty
                        const reservationList = document.getElementById('reservationList');
                        if (reservationList.children.length === 0) {
                            alert('All pending reservations have been processed.');
                        }
                    } else {
                        alert('Failed to confirm payment: ' + data.error);
                    }
                })
                .catch(error => console.error('Error confirming payment:', error));
        }

        // Attach event listener to the search bar
        document.getElementById('searchBar').addEventListener('input', filterReservations);

        // Initialize the page
        checkLoginStatus();
        updateLinks();
        fetchReservations();
    </script>

</body>
</html>
