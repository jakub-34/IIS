<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentation list</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div class="header-container">
        <h2 style="float: left;">
            <a href="index.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home" style="margin-right: 5px;"></i>
            </a>
            <a id="backLink" href="#" style="opacity: 0.5;">Presentations</a>
            <a style="margin-left: 0.8vw;" href="#">Suggestions</a>
        </h2>
        <div style="float: right;">
            <!-- Tlačítko Login/Logout -->
            <a href="login.html" id="loginLogoutButton" class="login-button">Login</a>
            <a href="user_schedule.html" id="myScheduleButton" class="login-button" style="margin-right: 10px; display: none;">My Schedule</a>
            <!-- Dynamické tlačítko Admin Page -->
            <a href="admin_page.html" id="adminPageButton" class="login-button" style="display: none; margin-right: 10px;">Admin Page</a>
        </div>
    </div>
    
    <div class="body">
        <table>
            <tbody id="presentationTable">
            </tbody>
        </table>
    </div>

<script>


if (sessionStorage.getItem('previousPage')) {
    document.getElementById('backLink').href = sessionStorage.getItem('previousPage');
}
sessionStorage.setItem('previousPage_forLogin', window.location.href);
// Funkce pro získání ID konference z URL parametru
function getConferenceId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id'); // Získá conference_id z URL, pokud existuje
}


// Funkce pro kontrolu stavu přihlášení
function checkLoginStatus() {
    fetch('check_session.php')
        .then(response => response.json())
        .then(data => {
            const loginLogoutButton = document.getElementById('loginLogoutButton');
            const adminPageButton = document.getElementById('adminPageButton');

            if (data.isLoggedIn) {
                loginLogoutButton.textContent = 'Logout';
                loginLogoutButton.href = 'logout.php';
                myScheduleButton.style.display = 'inline-block';

                if (data.role === 'admin') {
                    adminPageButton.style.display = 'inline-block';
                }

            } else {
                loginLogoutButton.textContent = 'Login';
                loginLogoutButton.href = 'login.html';
            }
        })
        .catch(error => console.error('Chyba při kontrole přihlášení:', error));
}

// Načtení stavu přihlášení po otevření stránky
checkLoginStatus();

function updatePresentationStatus(Id, status) {
    fetch('update_presentation_status.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            presentation_id: Id,
            status: status,
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Status byl úspěšně aktualizován');
        } else {
            console.error('Chyba při aktualizaci stavu');
        }
    })
    .catch(error => console.error('Chyba při komunikaci s serverem:', error));
}

function updatePresentation(data) {
    fetch('update_presentation.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('Presentation updated successfully.');
            } else {
                console.error('Failed to update presentation:', result.error);
            }
        })
        .catch(error => {
            console.error('Error updating presentation:', error);
        });
}


// Načtení prezentací z PHP skriptu
const conferenceId = getConferenceId();
fetch(`get_suggestions.php?conference_id=${conferenceId}`)
    .then(response => response.json())
    .then(data => {
        var count = 1;
        const tableBody = document.getElementById('presentationTable');

        // Hlavní obalovací div pro dva sloupce
        const mainContainer = document.createElement('div');
        mainContainer.style.display = 'flex';        
        mainContainer.style.justifyContent = 'space-between';
        mainContainer.style.gap = '20px';            

        // Levý a pravý sloupec
        const leftColumn = document.createElement('div');
        leftColumn.style.flex = '1';

        const rightColumn = document.createElement('div');
        rightColumn.style.flex = '1';

        // Iterace přes data konferencí
        data.forEach(conference => {
            const currentCount = count;
            const containerDiv = document.createElement('div');
            containerDiv.style.display = 'flex';
            containerDiv.style.alignItems = 'center';
            containerDiv.style.marginBottom = '10px';
            containerDiv.style.cursor = 'pointer';

            /*containerDiv.onclick = () => {
                window.location.href = `conference_details.html?id=${conference.conference_id}`;
            };*/

            const text = document.createElement('p');
            text.innerHTML = `${count}`;
            text.style.marginRight = '10px';
            text.style.fontWeight = 'bold';

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = "conference";

            const row1 = document.createElement('tr');
            row1.innerHTML = `<td colspan="2" style="font-weight: bold;">${conference.title}</td>`;
            row1.style.paddingBottom = '10vw';
            wrapperDiv.appendChild(row1);

            const row2 = document.createElement('tr');
            //row2.innerHTML = `<td>${new Date(conference.start_datetime).toLocaleDateString()} - ${new Date(conference.end_datetime).toLocaleDateString()}</td><td>${new Date(conference.start_datetime).toLocaleTimeString('cs-CZ',  { hour: '2-digit', minute: '2-digit', hour12: false })}</td>-<td>${new Date(conference.end_datetime).toLocaleTimeString('cs-CZ',  { hour: '2-digit', minute: '2-digit', hour12: false })}</td>`;
            row2.innerHTML = `<td colspan="2">${conference.description}</td>`;
            wrapperDiv.appendChild(row2);


            const row3 = document.createElement('tr');
            row3.innerHTML = `
                <td>
                    <label for="date-${currentCount}">Date:</label>
                    <input type="date" id="date-${currentCount}" name="date-${currentCount}" value="${conference.date ? new Date(conference.date).toISOString().split('T')[0] : ''}">
                </td>
            `;
            wrapperDiv.appendChild(row3);

            const row4 = document.createElement('tr');
            row4.innerHTML = `
                <td>
                    <label for="start_time-${currentCount}">Start Time:</label>
                    <input type="time" id="start_time-${currentCount}" name="start_time-${currentCount}" value="${conference.start_time ? formatTime(conference.start_time) : ''}">
                </td>
                <td>
                    <label for="end_time-${currentCount}">End Time:</label>
                    <input type="time" id="end_time-${currentCount}" name="end_time-${currentCount}" value="${conference.end_time ? formatTime(conference.end_time) : ''}">
                </td>
            `;
            wrapperDiv.appendChild(row4);
            
            function formatTime(timeString) {
                if (!timeString) return '';

                let date = new Date('1970-01-01T' + timeString + 'Z');
                let hours = date.getUTCHours().toString().padStart(2, '0');
                let minutes = date.getUTCMinutes().toString().padStart(2, '0');

                return `${hours}:${minutes}`;
            }
            
            const row5 = document.createElement('tr');
            row5.innerHTML = `
                <td>
                    <label>Room:</label>
                    <input type="text" id="room-${currentCount}" value="${conference.room_name || ''}">
                </td>
            `;
            wrapperDiv.appendChild(row5);




            const row6 = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;

            // Vytvoření checkboxu
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `checkbox-${count}`;
            checkbox.name = `conference-${count}`;
            checkbox.value = conference.presentation_id;
            
            // Pokud je status "approved", checkbox bude zaškrtnutý
            checkbox.checked = (conference.status === 'approved');

            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    // Při zaškrtnutí checkboxu validujeme povinné vstupy
                    const dateInput = document.getElementById(`date-${currentCount}`);
                    const startTimeInput = document.getElementById(`start_time-${currentCount}`);
                    const endTimeInput = document.getElementById(`end_time-${currentCount}`);
                    const roomInput = document.getElementById(`room-${currentCount}`);
                    
                    console.log(currentCount);
                    /*if (!dateInput || !startTimeInput || !endTimeInput || !roomInput) {
                        alert('Required inputs are missing from the DOM.');
                        checkbox.checked = false;
                        return;
                    }*/

                    // Kontrola, zda jsou všechna povinná pole vyplněná
                    if (!dateInput.value || !startTimeInput.value || !endTimeInput.value || !roomInput.value) {
                        alert('Please fill in all required fields before adding to the conference.');
                        checkbox.checked = false; // Vrátí checkbox do nezaškrtnutého stavu
                        return;
                    }
                    else
                    {
                        const data = {
                            presentation_id: conference.presentation_id,
                            date: dateInput.value,
                            start_time: startTimeInput.value,
                            end_time: endTimeInput.value,
                            room: roomInput.value,
                            status: 'approved'
                        };
                        updatePresentation(data);
                    }
                }
                else{
                    updatePresentationStatus(conference.presentation_id, checkbox.checked ? 'approved' : 'not_approved')
                }
            });
            

            // Vytvoření labelu pro checkbox
            const label = document.createElement('label');
            label.setAttribute('for', checkbox.id);
            label.textContent = 'Add to conference';

            // Připojení labelu a checkboxu do tabulky
            td.appendChild(label);
            td.appendChild(checkbox);
            row6.appendChild(td);
            wrapperDiv.appendChild(row6);


            containerDiv.appendChild(text);
            containerDiv.appendChild(wrapperDiv);

            if (count % 2 !== 0) {
                leftColumn.appendChild(containerDiv);
            } else {
                rightColumn.appendChild(containerDiv);
            }

            count++;
        });

        mainContainer.appendChild(leftColumn);
        mainContainer.appendChild(rightColumn);
        tableBody.appendChild(mainContainer);
         // Po načtení konferencí načteme místnosti

    })


/*fetch(`conference_details.php?conference_id=${conferenceId}`)
    .then(response => response.json())
    .then(data => {
        var count = 1;
        const tableBody = document.getElementById('presentationTable');

        // Hlavní obalovací div pro dva sloupce
        const mainContainer = document.createElement('div');
        mainContainer.style.display = 'flex';        
        mainContainer.style.justifyContent = 'space-between';
        mainContainer.style.gap = '20px';            


        // Levý a pravý sloupec
        const leftColumn = document.createElement('div');
        leftColumn.style.flex = '1';

        const rightColumn = document.createElement('div');
        rightColumn.style.flex = '1';

        // Iterace přes data prezentací
        data.forEach(presentation => {
            const containerDiv = document.createElement('div');
            containerDiv.style.display = 'flex';
            containerDiv.style.alignItems = 'center';
            containerDiv.style.marginBottom = '10px';
            containerDiv.style.cursor = 'pointer';

            const text = document.createElement('p');
            text.innerHTML = `${count}`;
            text.style.marginRight = '10px';
            text.style.fontWeight = 'bold';

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = "presentation";

            // Prezentace - řádky
            const row1 = document.createElement('tr');
            row1.innerHTML = `<td colspan="2" style="font-weight: bold;">${presentation.title}</td>`;
            row1.style.paddingBottom = '10vw';
            wrapperDiv.appendChild(row1);

            const row2 = document.createElement('tr');
            row2.innerHTML = `<td>${new Date(presentation.start_time).toLocaleDateString()} - ${new Date(presentation.end_time).toLocaleDateString()}</td><td>${new Date(presentation.start_time).toLocaleTimeString('cs-CZ',  { hour: '2-digit', minute: '2-digit', hour12: false })}</td>-<td>${new Date(presentation.end_time).toLocaleTimeString('cs-CZ',  { hour: '2-digit', minute: '2-digit', hour12: false })}</td>`;
            wrapperDiv.appendChild(row2);

            containerDiv.appendChild(text);
            containerDiv.appendChild(wrapperDiv);

            if (count % 2 !== 0) {
                leftColumn.appendChild(containerDiv);
            } else {
                rightColumn.appendChild(containerDiv);
            }

            count++;
        });

        mainContainer.appendChild(leftColumn);
        mainContainer.appendChild(rightColumn);
        tableBody.appendChild(mainContainer);
        //tableBody.appendChild(mainContainer);

    });*/
</script>

</body>
</html>
